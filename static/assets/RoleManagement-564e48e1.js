import{g as e,a as l,c as o,u as t,d as s}from"./role-65517889.js";import{c as i,o as a,d,f as n,w as r,e as c,i as u,q as h,x as m,n as p,F as R,O as f,p as w}from"./index-996b1aff.js";import{_ as y}from"./_plugin-vue_export-helper-1b428a4d.js";const g={class:"role-management-page"},b={class:"table-actions"},_={key:0,class:"text-center py-4"},v={key:1},k={key:0,class:"text-center py-4"},V={key:0,class:"role-desc"},x={key:1,class:"text-muted"},C={class:"tree-node-row"},A={key:0,class:"tree-actions"},P={class:"text-end"},M={class:"tree-node-row"},D={key:0,class:"tree-actions"},U={class:"text-end"};const E=y({name:"RoleManagement",data:()=>({roles:[],permissions:[],allPermissions:[],selectedRole:null,selectedRolePermissionIds:[],loadingRoles:!1,loadingPermissions:!1,loadingAllPermissions:!1,creatingRole:!1,updatingRole:!1,creatingPermission:!1,deletingRole:!1,savingPermissions:!1,showCreateRoleModal:!1,showEditRoleModal:!1,showCreatePermissionModal:!1,showDeleteRoleModal:!1,newRole:{name:"",description:"",permission_ids:[]},editedRole:{id:null,name:"",description:""},newPermission:{code:"",name:"",description:"",type:"read"},roleToDelete:null,selectedActions:{},roleRules:{name:[{required:!0,message:"请输入角色名称",trigger:"blur"}]},searchQuery:""}),computed:{filteredRoles(){if(!this.searchQuery)return this.roles;const e=this.searchQuery.toLowerCase();return this.roles.filter((l=>l.name.toLowerCase().includes(e)||l.description&&l.description.toLowerCase().includes(e)))}},created(){this.fetchRoles(),this.fetchAllPermissions()},methods:{async fetchRoles(){this.loadingRoles=!0;try{const l=await e();this.roles=l.data}catch(l){this.$toast.error("获取角色列表失败")}finally{this.loadingRoles=!1}},async fetchAllPermissions(){this.loadingAllPermissions=!0;try{const e=await l();this.allPermissions=e.data,this.permissions=[...this.allPermissions]}catch(e){this.$toast.error("获取权限列表失败")}finally{this.loadingAllPermissions=!1}},selectRole(e){this.selectedRole=e;const l={};e.permissions&&Array.isArray(e.permissions)&&e.permissions.forEach((e=>{l[e.id]=Array.isArray(e.actions)?[...e.actions]:[]})),this.selectedActions=l},buildPermissionsPayload(){return Object.entries(this.selectedActions).filter((([e,l])=>l&&l.length>0)).map((([e,l])=>({id:e,actions:l})))},async createRole(){var e,l;this.creatingRole=!0;try{const e={name:this.newRole.name,description:this.newRole.description,permissions:this.buildPermissionsPayload()};await o(e),this.$toast.success("角色创建成功"),this.showCreateRoleModal=!1,this.resetNewRole(),this.fetchRoles()}catch(t){this.$toast.error((null==(l=null==(e=t.response)?void 0:e.data)?void 0:l.detail)||"创建角色失败")}finally{this.creatingRole=!1}},resetNewRole(){this.newRole={name:"",description:"",permission_ids:[]},this.selectedActions={}},editRole(e){this.editedRole={id:e.id,name:e.name,description:e.description};const l={};e.permissions&&Array.isArray(e.permissions)&&e.permissions.forEach((e=>{l[e.id]=Array.isArray(e.actions)?[...e.actions]:[]})),this.selectedActions=l,this.showEditRoleModal=!0},async updateRole(){var e,l;this.updatingRole=!0;try{const e=this.buildPermissionsPayload(),l={name:this.editedRole.name,description:this.editedRole.description,permissions:e};await t(this.editedRole.id,l),this.$toast.success("角色更新成功"),this.showEditRoleModal=!1;const o=this.roles.findIndex((e=>e.id===this.editedRole.id));-1!==o&&(this.roles[o].name=this.editedRole.name,this.roles[o].description=this.editedRole.description,this.roles[o].permissions=e)}catch(o){this.$toast.error((null==(l=null==(e=o.response)?void 0:e.data)?void 0:l.detail)||"更新角色失败")}finally{this.updatingRole=!1}},confirmDeleteRole(e){this.roleToDelete=e,this.showDeleteRoleModal=!0},async deleteRole(){var e,l;if(this.roleToDelete){this.deletingRole=!0;try{await s(this.roleToDelete.id),this.$toast.success("角色删除成功"),this.showDeleteRoleModal=!1,this.roles=this.roles.filter((e=>e.id!==this.roleToDelete.id)),this.selectedRole&&this.selectedRole.id===this.roleToDelete.id&&(this.selectedRole=null,this.selectedRolePermissionIds=[]),this.roleToDelete=null}catch(o){this.$toast.error((null==(l=null==(e=o.response)?void 0:e.data)?void 0:l.detail)||"删除角色失败")}finally{this.deletingRole=!1}}},getPermissionBadgeClass(e){switch(e){case"read":return"badge bg-info";case"write":return"badge bg-success";case"delete":return"badge bg-danger";case"admin":return"badge bg-warning";default:return"badge bg-secondary"}},sortedActions:e=>e.slice().sort(((e,l)=>"read"===e.action&&"read"!==l.action?-1:"read"!==e.action&&"read"===l.action?1:0)),searchRoles(){}}},[["render",function(e,l,o,t,s,y){const E=i("el-input"),T=i("Plus"),$=i("el-icon"),Q=i("el-button"),j=i("el-skeleton"),q=i("el-table-column"),I=i("Edit"),S=i("Delete"),z=i("el-table"),F=i("el-card"),L=i("el-form-item"),N=i("el-checkbox"),O=i("el-checkbox-group"),B=i("el-tree"),G=i("el-form"),H=i("el-dialog");return a(),d("div",g,[n(F,{shadow:"hover"},{header:r((()=>l[12]||(l[12]=[c("div",{class:"header-bar"},[c("span",null,"角色列表")],-1)]))),default:r((()=>[c("div",b,[n(E,{modelValue:s.searchQuery,"onUpdate:modelValue":l[0]||(l[0]=e=>s.searchQuery=e),placeholder:"搜索角色...",clearable:"",style:{width:"180px"}},null,8,["modelValue"]),n(Q,{type:"primary",onClick:l[1]||(l[1]=e=>s.showCreateRoleModal=!0)},{default:r((()=>[n($,null,{default:r((()=>[n(T)])),_:1}),l[13]||(l[13]=u(" 新建角色 "))])),_:1})]),s.loadingRoles?(a(),d("div",_,[n(j,{rows:4,animated:""})])):(a(),d("div",v,[0===y.filteredRoles.length?(a(),d("div",k,l[14]||(l[14]=[c("p",{class:"mb-0"},"暂无角色数据",-1)]))):(a(),h(z,{key:1,data:y.filteredRoles,style:{width:"100%"},size:"small",onRowClick:y.selectRole},{default:r((()=>[n(q,{prop:"name",label:"角色名","min-width":"100"}),n(q,{prop:"description",label:"描述","min-width":"120"},{default:r((({row:e})=>[e.description?(a(),d("span",V,m(e.description),1)):(a(),d("span",x,"-"))])),_:1}),n(q,{label:"操作",width:"90"},{default:r((({row:e})=>[n(Q,{size:"small",onClick:p((l=>y.editRole(e)),["stop"]),circle:""},{default:r((()=>[n($,null,{default:r((()=>[n(I)])),_:1})])),_:2},1032,["onClick"]),n(Q,{size:"small",type:"danger",onClick:p((l=>y.confirmDeleteRole(e)),["stop"]),circle:""},{default:r((()=>[n($,null,{default:r((()=>[n(S)])),_:1})])),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data","onRowClick"]))]))])),_:1}),n(H,{modelValue:s.showCreateRoleModal,"onUpdate:modelValue":l[5]||(l[5]=e=>s.showCreateRoleModal=e),title:"新建角色",width:"500px"},{default:r((()=>[n(G,{model:s.newRole,rules:s.roleRules,ref:"roleForm","label-width":"80px","label-position":"left",onSubmit:p(y.createRole,["prevent"])},{default:r((()=>[n(L,{label:"角色名称",prop:"name"},{default:r((()=>[n(E,{modelValue:s.newRole.name,"onUpdate:modelValue":l[2]||(l[2]=e=>s.newRole.name=e),placeholder:"请输入角色名称",required:""},null,8,["modelValue"])])),_:1}),n(L,{label:"描述"},{default:r((()=>[n(E,{modelValue:s.newRole.description,"onUpdate:modelValue":l[3]||(l[3]=e=>s.newRole.description=e),type:"textarea",rows:2,placeholder:"可选"},null,8,["modelValue"])])),_:1}),n(L,{label:"选择权限"},{default:r((()=>[n(B,{data:s.allPermissions,"node-key":"id",props:{label:"label",children:"children"},"default-expand-all":"","expand-on-click-node":!1,style:{"padding-left":"8px"}},{default:r((({node:e,data:l})=>[c("div",C,[c("span",null,m(l.label),1),l.actions?(a(),d("div",A,[n(O,{modelValue:s.selectedActions[l.id],"onUpdate:modelValue":e=>s.selectedActions[l.id]=e},{default:r((()=>[(a(!0),d(R,null,f(y.sortedActions(l.actions),(e=>(a(),h(N,{key:e.action,value:e.action},{default:r((()=>[u(m(e.label),1)])),_:2},1032,["value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue"])])):w("",!0)])])),_:1},8,["data"])])),_:1}),c("div",P,[n(Q,{onClick:l[4]||(l[4]=e=>s.showCreateRoleModal=!1)},{default:r((()=>l[15]||(l[15]=[u("取消")]))),_:1}),n(Q,{type:"primary",loading:s.creatingRole,onClick:y.createRole},{default:r((()=>l[16]||(l[16]=[u("创建")]))),_:1},8,["loading","onClick"])])])),_:1},8,["model","rules","onSubmit"])])),_:1},8,["modelValue"]),n(H,{modelValue:s.showEditRoleModal,"onUpdate:modelValue":l[9]||(l[9]=e=>s.showEditRoleModal=e),title:"编辑角色",width:"500px"},{default:r((()=>[n(G,{model:s.editedRole,rules:s.roleRules,ref:"editRoleForm","label-width":"80px","label-position":"left",onSubmit:p(y.updateRole,["prevent"])},{default:r((()=>[n(L,{label:"角色名称",prop:"name"},{default:r((()=>[n(E,{modelValue:s.editedRole.name,"onUpdate:modelValue":l[6]||(l[6]=e=>s.editedRole.name=e),required:""},null,8,["modelValue"])])),_:1}),n(L,{label:"描述"},{default:r((()=>[n(E,{modelValue:s.editedRole.description,"onUpdate:modelValue":l[7]||(l[7]=e=>s.editedRole.description=e),type:"textarea",rows:2},null,8,["modelValue"])])),_:1}),n(L,{label:"选择权限"},{default:r((()=>[n(B,{data:s.allPermissions,"node-key":"id",props:{label:"label",children:"children"},"default-expand-all":"","expand-on-click-node":!1,style:{"padding-left":"8px"}},{default:r((({node:e,data:l})=>[c("div",M,[c("span",null,m(l.label),1),l.actions?(a(),d("div",D,[n(O,{modelValue:s.selectedActions[l.id],"onUpdate:modelValue":e=>s.selectedActions[l.id]=e},{default:r((()=>[(a(!0),d(R,null,f(y.sortedActions(l.actions),(e=>(a(),h(N,{key:e.action,value:e.action},{default:r((()=>[u(m(e.label),1)])),_:2},1032,["value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue"])])):w("",!0)])])),_:1},8,["data"])])),_:1}),c("div",U,[n(Q,{onClick:l[8]||(l[8]=e=>s.showEditRoleModal=!1)},{default:r((()=>l[17]||(l[17]=[u("取消")]))),_:1}),n(Q,{type:"primary",loading:s.updatingRole,onClick:y.updateRole},{default:r((()=>l[18]||(l[18]=[u("保存")]))),_:1},8,["loading","onClick"])])])),_:1},8,["model","rules","onSubmit"])])),_:1},8,["modelValue"]),n(H,{modelValue:s.showDeleteRoleModal,"onUpdate:modelValue":l[11]||(l[11]=e=>s.showDeleteRoleModal=e),title:"确认删除",width:"350px"},{footer:r((()=>[n(Q,{onClick:l[10]||(l[10]=e=>s.showDeleteRoleModal=!1)},{default:r((()=>l[22]||(l[22]=[u("取消")]))),_:1}),n(Q,{type:"danger",loading:s.deletingRole,onClick:y.deleteRole},{default:r((()=>l[23]||(l[23]=[u("删除")]))),_:1},8,["loading","onClick"])])),default:r((()=>{var e;return[c("div",null,[c("p",null,[l[19]||(l[19]=u("确定要删除角色 ")),c("strong",null,m(null==(e=s.roleToDelete)?void 0:e.name),1),l[20]||(l[20]=u(" 吗？此操作不可撤销。"))]),l[21]||(l[21]=c("p",{class:"text-danger"},"如果此角色已被用户使用，则无法删除。",-1))])]})),_:1},8,["modelValue"])])}],["__scopeId","data-v-d1e2097d"]]);export{E as default};
