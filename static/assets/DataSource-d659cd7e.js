import{c as e,o as a,d as t,f as l,w as s,e as i,g as r,i as o,x as n,q as d,p as m,t as c,z as p,F as u,O as h}from"./index-996b1aff.js";import{P as g}from"./index-e7ada867.js";import{D as f}from"./DynamicForm-adccf113.js";import{g as y,a as b,c as _,u as w,d as V}from"./datasource-54b16d5f.js";import{_ as T}from"./_plugin-vue_export-helper-1b428a4d.js";const F={class:"datasource-page"},$={class:"header-bar"},x={class:"table-actions"},k={class:"left-actions"},v={class:"right-actions"},D={key:0,class:"text-center py-4"},C={key:1},U={class:"param-scroll-area"},z={key:1,style:{color:"#b0b3b8"}},L={class:"text-end"};const S=T({name:"DataSource",components:{Pagination:g,DynamicForm:f},data:()=>({list:null,total:0,listLoading:!0,listQuery:{page:1,size:20,name:void 0},dialogFormVisible:!1,dialogStatus:"",temp:{id:void 0,name:"",description:"",class_name:"",params:{}},rules:{name:[{required:!0,message:"请输入名称",trigger:"blur"}],class_name:[{required:!0,message:"请选择类型",trigger:"blur"}]},templates:[],selectedTemplate:null,dynamicFormKey:0}),created(){this.getList(),this.getTemplates()},methods:{async getList(){this.listLoading=!0;try{const{data:e}=await y(this.listQuery);this.list=e,this.total=e.length}catch(e){this.$message.error("获取数据源列表失败")}this.listLoading=!1},async getTemplates(){try{const{data:e}=await b({project_id:this.temp.project_id});this.templates=e}catch(e){this.$message.error("获取数据源模板失败")}},handleFilter(){this.listQuery.page=1,this.getList()},resetTemp(){this.temp={id:void 0,name:"",description:"",class_name:"",params:{}},this.dynamicFormKey++},handleCreate(){this.resetTemp(),this.dialogStatus="create",this.dialogFormVisible=!0,this.$nextTick((()=>{this.$refs.dataForm.clearValidate()}))},handleUpdate(e){if(this.temp=Object.assign({},e),"string"==typeof this.temp.params)try{this.temp.params=JSON.parse(this.temp.params)}catch{this.temp.params={}}this.temp.params&&"object"==typeof this.temp.params||(this.temp.params={}),this.selectedTemplate=this.templates.find((e=>e.cls===this.temp.class_name)),this.dialogStatus="update",this.dialogFormVisible=!0,this.$nextTick((()=>{this.$refs.dataForm.clearValidate()}))},async createData(){this.$nextTick((()=>{this.$refs.dataForm.validate((async e=>{if(e)try{await _(this.temp),this.dialogFormVisible=!1,this.$message.success("创建成功"),this.getList()}catch(a){this.$message.error("创建失败")}}))}))},async updateData(){this.$nextTick((()=>{this.$refs.dataForm.validate((async e=>{if(e)try{await w(this.temp.id,this.temp),this.dialogFormVisible=!1,this.$message.success("更新成功"),this.getList()}catch(a){this.$message.error("更新失败")}}))}))},async handleDelete(e){try{await this.$confirm("确认删除该数据源?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await V(e.id),this.$message.success("删除成功"),this.getList()}catch(a){"cancel"!==a&&this.$message.error("删除失败")}},handleTemplateChange(e){this.selectedTemplate=this.templates.find((a=>a.cls===e)),this.temp.params={},this.dynamicFormKey++},getTemplateDisplayName(e){const a=this.templates.find((a=>a.cls===e));return a?a.name:e},getTemplateTag(e){const a=this.templates.find((a=>a.cls===e));return a?a.tag:""},formatDate(e){if(!e)return"";const a=new Date(e),t=e=>e.toString().padStart(2,"0");return`${a.getFullYear()}-${t(a.getMonth()+1)}-${t(a.getDate())} ${t(a.getHours())}:${t(a.getMinutes())}:${t(a.getSeconds())}`},async handleEnableChange(e,a){try{await w(e.id,{is_enabled:a}),this.$message.success(a?"已启用":"已禁用")}catch(t){this.$message.error("操作失败"),e.is_enabled=!a}},formatTag:e=>e}},[["render",function(g,f,y,b,_,w){const V=e("el-input"),T=e("Plus"),S=e("el-icon"),j=e("el-button"),Q=e("el-skeleton"),K=e("el-table-column"),P=e("el-tag"),q=e("el-switch"),E=e("Edit"),N=e("Delete"),O=e("el-table"),B=e("pagination"),I=e("el-card"),M=e("el-form-item"),H=e("el-option"),J=e("el-select"),Y=e("DynamicForm"),A=e("el-form"),G=e("el-dialog");return a(),t("div",F,[l(I,{shadow:"hover"},{header:s((()=>[i("div",$,[i("div",x,[i("div",k,[l(V,{modelValue:_.listQuery.name,"onUpdate:modelValue":f[0]||(f[0]=e=>_.listQuery.name=e),placeholder:"数据源名称",style:{width:"200px"},class:"filter-item",onKeyup:r(w.handleFilter,["enter"])},null,8,["modelValue","onKeyup"])]),i("div",v,[l(j,{type:"primary",onClick:w.handleCreate},{default:s((()=>[l(S,null,{default:s((()=>[l(T)])),_:1}),f[10]||(f[10]=o(" 添加数据源 "))])),_:1},8,["onClick"])])])])])),default:s((()=>[_.listLoading?(a(),t("div",D,[l(Q,{rows:4,animated:""})])):(a(),t("div",C,[l(O,{data:_.list||[],style:{width:"100%"},size:"small",border:"",fit:"","highlight-current-row":""},{default:s((()=>[l(K,{align:"center",label:"ID",width:"95"},{default:s((e=>[o(n(e.row.id),1)])),_:1}),l(K,{label:"名称"},{default:s((e=>[o(n(e.row.name),1)])),_:1}),l(K,{label:"类型"},{default:s((e=>[o(n(w.getTemplateDisplayName(e.row.class_name))+" ",1),w.getTemplateTag(e.row.class_name)?(a(),d(P,{key:0,size:"small",type:"info",effect:"plain",style:{"margin-left":"4px","font-size":"12px",color:"#b0b3b8","border-color":"#e0e0e0"}},{default:s((()=>[o(n(w.formatTag(w.getTemplateTag(e.row.class_name))),1)])),_:2},1024)):m("",!0)])),_:1}),l(K,{label:"创建时间",width:"180"},{default:s((e=>[o(n(w.formatDate(e.row.created_at)),1)])),_:1}),l(K,{label:"是否启用",align:"center",width:"100"},{default:s((e=>[l(q,{modelValue:e.row.is_enabled,"onUpdate:modelValue":a=>e.row.is_enabled=a,onChange:a=>w.handleEnableChange(e.row,a)},null,8,["modelValue","onUpdate:modelValue","onChange"])])),_:1}),l(K,{label:"操作",align:"center",width:"120"},{default:s((e=>[l(j,{size:"small",onClick:a=>w.handleUpdate(e.row),circle:""},{default:s((()=>[l(S,null,{default:s((()=>[l(E)])),_:1})])),_:2},1032,["onClick"]),l(j,{size:"small",type:"danger",onClick:a=>w.handleDelete(e.row),circle:""},{default:s((()=>[l(S,null,{default:s((()=>[l(N)])),_:1})])),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])])),c(l(B,{total:_.total,page:_.listQuery.page,"onUpdate:page":f[1]||(f[1]=e=>_.listQuery.page=e),limit:_.listQuery.size,"onUpdate:limit":f[2]||(f[2]=e=>_.listQuery.size=e),onPagination:w.getList},null,8,["total","page","limit","onPagination"]),[[p,_.total>0]])])),_:1}),l(G,{title:"create"===_.dialogStatus?"创建数据源":"编辑数据源",modelValue:_.dialogFormVisible,"onUpdate:modelValue":f[9]||(f[9]=e=>_.dialogFormVisible=e),width:"700px"},{footer:s((()=>[i("div",L,[l(j,{onClick:f[7]||(f[7]=e=>_.dialogFormVisible=!1)},{default:s((()=>f[11]||(f[11]=[o("取消")]))),_:1}),l(j,{type:"primary",onClick:f[8]||(f[8]=e=>"create"===_.dialogStatus?w.createData():w.updateData())},{default:s((()=>f[12]||(f[12]=[o(" 确认 ")]))),_:1})])])),default:s((()=>[l(A,{ref:"dataForm",rules:_.rules,model:_.temp,"label-position":"right","label-width":"100px"},{default:s((()=>[l(M,{label:"名称",prop:"name"},{default:s((()=>[l(V,{modelValue:_.temp.name,"onUpdate:modelValue":f[3]||(f[3]=e=>_.temp.name=e)},null,8,["modelValue"])])),_:1}),l(M,{label:"描述",prop:"description"},{default:s((()=>[l(V,{modelValue:_.temp.description,"onUpdate:modelValue":f[4]||(f[4]=e=>_.temp.description=e),type:"textarea"},null,8,["modelValue"])])),_:1}),l(M,{label:"类型",prop:"class_name"},{default:s((()=>[l(J,{modelValue:_.temp.class_name,"onUpdate:modelValue":f[5]||(f[5]=e=>_.temp.class_name=e),placeholder:"请选择数据源类型",onChange:w.handleTemplateChange,filterable:"",clearable:""},{default:s((()=>[(a(!0),t(u,null,h(_.templates,(e=>(a(),d(H,{key:e.cls,label:e.name,value:e.cls},{default:s((()=>[i("span",null,n(e.name),1),e.tag?(a(),d(P,{key:0,size:"small",type:"info",effect:"plain",style:{"margin-left":"6px","font-size":"12px",color:"#b0b3b8","border-color":"#e0e0e0"}},{default:s((()=>[o(n(w.formatTag(e.tag)),1)])),_:2},1024)):m("",!0)])),_:2},1032,["label","value"])))),128))])),_:1},8,["modelValue","onChange"])])),_:1}),l(M,{label:"参数",prop:"params"},{default:s((()=>[i("div",U,[_.selectedTemplate&&_.temp.class_name?(a(),d(Y,{ref:"dynamicForm",fields:_.selectedTemplate.parameters,modelValue:_.temp.params,"onUpdate:modelValue":f[6]||(f[6]=e=>_.temp.params=e),key:_.dynamicFormKey},null,8,["fields","modelValue"])):(a(),t("div",z,"请选择数据源类型后填写参数"))])])),_:1})])),_:1},8,["rules","model"])])),_:1},8,["title","modelValue"])])}],["__scopeId","data-v-26e14e51"]]);export{S as default};
