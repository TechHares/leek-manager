import{L as e,a3 as l,c as a,N as s,o as t,d,f as r,w as i,e as o,g as u,i as n,t as m,q as c,F as h,O as p,p as U,x as _,n as f}from"./index-996b1aff.js";import{g as w}from"./role-65517889.js";import{_ as g}from"./_plugin-vue_export-helper-1b428a4d.js";const V={class:"user-management"},y={class:"table-actions"},b={key:0,class:"text-muted"},v={key:1};const C=g({name:"UserManagement",data:()=>({users:[],roles:[],searchQuery:"",loading:!1,loadingRoles:!1,creating:!1,updating:!1,deleting:!1,showCreateUserModal:!1,showEditUserModal:!1,showDeleteConfirmModal:!1,currentUserId:null,newUser:{username:"",email:"",password:"",is_active:!0,is_admin:!1,role_ids:[]},editedUser:{id:null,username:"",email:"",password:"",is_active:!0,is_admin:!1,role_ids:[]},userToDelete:null,userRules:{username:[{required:!0,message:"请输入用户名",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"邮箱格式不正确",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}]}}),async created(){const e=l();this.currentUserId=e?e.id:null,this.fetchUsers(),this.fetchRoles()},methods:{async fetchUsers(){this.loading=!0;try{const l=await e.get("/authorization/users");this.users=l.data}catch(l){this.$toast.error("获取用户列表失败")}finally{this.loading=!1}},async fetchRoles(){this.loadingRoles=!0;try{const e=await w();this.roles=e.data}catch(e){this.$toast.error("获取角色列表失败")}finally{this.loadingRoles=!1}},async createUser(){this.$refs.createUserForm.validate((async l=>{var a,s;if(l){this.creating=!0;try{await(t=this.newUser,e.post("/authorization/users",t)),this.$toast.success("用户创建成功"),this.showCreateUserModal=!1,this.resetNewUser(),this.fetchUsers()}catch(d){this.$toast.error((null==(s=null==(a=d.response)?void 0:a.data)?void 0:s.detail)||"创建用户失败")}finally{this.creating=!1}var t}}))},resetNewUser(){this.newUser={username:"",email:"",password:"",is_active:!0,is_admin:!1,role_ids:[]}},editUser(e){this.editedUser={id:e.id,username:e.username,email:e.email,password:"",is_active:e.is_active,is_admin:e.is_admin,role_ids:e.role_ids},this.showEditUserModal=!0},async updateUser(){this.$refs.editUserForm.validate((async l=>{var a,s;if(!l)return;this.updating=!0;const t={};this.editedUser.email&&(t.email=this.editedUser.email),this.editedUser.password&&(t.password=this.editedUser.password),t.is_active=this.editedUser.is_active,t.is_admin=this.editedUser.is_admin,t.role_ids=this.editedUser.role_ids;try{await(d=this.editedUser.id,r=t,e.put(`/authorization/users/${d}`,r)),this.$toast.success("用户更新成功"),this.showEditUserModal=!1,this.fetchUsers()}catch(i){this.$toast.error((null==(s=null==(a=i.response)?void 0:a.data)?void 0:s.detail)||"更新用户失败")}finally{this.updating=!1}var d,r}))},confirmDeleteUser(e){this.userToDelete=e,this.showDeleteConfirmModal=!0},async deleteUser(){var l,a;if(this.userToDelete){this.deleting=!0;try{await(s=this.userToDelete.id,e.delete(`/authorization/users/${s}`)),this.$toast.success("用户删除成功"),this.showDeleteConfirmModal=!1,this.userToDelete=null,this.fetchUsers()}catch(t){this.$toast.error((null==(a=null==(l=t.response)?void 0:l.data)?void 0:a.detail)||"删除用户失败")}finally{this.deleting=!1}var s}},searchUsers(){if(!this.searchQuery)return void this.fetchUsers();const e=this.searchQuery.toLowerCase();this.users=this.users.filter((l=>l.username.toLowerCase().includes(e)||l.email&&l.email.toLowerCase().includes(e)))}}},[["render",function(e,l,w,g,C,k){const M=a("el-input"),D=a("Plus"),x=a("el-icon"),$=a("el-button"),R=a("el-table-column"),q=a("el-tag"),z=a("Edit"),E=a("Delete"),I=a("el-table"),T=a("el-card"),F=a("el-form-item"),Q=a("el-checkbox"),L=a("el-checkbox-group"),S=a("el-form"),j=a("el-dialog"),N=s("loading");return t(),d("div",V,[r(T,{shadow:"hover"},{header:i((()=>l[20]||(l[20]=[o("div",{class:"header-bar"},[o("span",null,"用户列表")],-1)]))),default:i((()=>[o("div",y,[r(M,{modelValue:C.searchQuery,"onUpdate:modelValue":l[0]||(l[0]=e=>C.searchQuery=e),placeholder:"搜索用户...",clearable:"",onKeyup:u(k.searchUsers,["enter"]),style:{width:"180px"}},null,8,["modelValue","onKeyup"]),r($,{type:"primary",onClick:l[1]||(l[1]=e=>C.showCreateUserModal=!0)},{default:i((()=>[r(x,null,{default:i((()=>[r(D)])),_:1}),l[21]||(l[21]=n(" 新建用户 "))])),_:1})]),m((t(),c(I,{data:C.users,style:{width:"100%"}},{default:i((()=>[r(R,{prop:"id",label:"ID",width:"60"}),r(R,{prop:"username",label:"用户名"}),r(R,{prop:"email",label:"邮箱"}),r(R,{label:"角色"},{default:i((({row:e})=>[(t(!0),d(h,null,p(e.role_ids,(e=>(t(),c(q,{key:e,size:"small",class:"ml-1"},{default:i((()=>{var l;return[n(_((null==(l=C.roles.find((l=>l.id===e)))?void 0:l.name)||"未知角色"),1)]})),_:2},1024)))),128)),e.role_ids&&0!==e.role_ids.length?U("",!0):(t(),d("span",b,"无角色"))])),_:1}),r(R,{label:"状态"},{default:i((({row:e})=>[r(q,{type:e.is_active?"success":"danger"},{default:i((()=>[n(_(e.is_active?"活跃":"禁用"),1)])),_:2},1032,["type"])])),_:1}),r(R,{label:"管理员"},{default:i((({row:e})=>[e.is_admin?(t(),c(q,{key:0,type:"warning"},{default:i((()=>l[22]||(l[22]=[n("管理员")]))),_:1})):(t(),d("span",v,"-"))])),_:1}),r(R,{label:"操作",width:"120"},{default:i((({row:e})=>[r($,{size:"small",onClick:f((l=>k.editUser(e)),["stop"]),circle:""},{default:i((()=>[r(x,null,{default:i((()=>[r(z)])),_:1})])),_:2},1032,["onClick"]),r($,{size:"small",type:"danger",onClick:f((l=>k.confirmDeleteUser(e)),["stop"]),circle:""},{default:i((()=>[r(x,null,{default:i((()=>[r(E)])),_:1})])),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])),[[N,C.loading]])])),_:1}),r(j,{modelValue:C.showCreateUserModal,"onUpdate:modelValue":l[9]||(l[9]=e=>C.showCreateUserModal=e),title:"创建新用户",width:"400px"},{default:i((()=>[r(S,{onSubmit:f(k.createUser,["prevent"]),model:C.newUser,rules:C.userRules,ref:"createUserForm","label-width":"80px"},{default:i((()=>[r(F,{label:"用户名",prop:"username"},{default:i((()=>[r(M,{modelValue:C.newUser.username,"onUpdate:modelValue":l[2]||(l[2]=e=>C.newUser.username=e),required:""},null,8,["modelValue"])])),_:1}),r(F,{label:"邮箱",prop:"email"},{default:i((()=>[r(M,{modelValue:C.newUser.email,"onUpdate:modelValue":l[3]||(l[3]=e=>C.newUser.email=e)},null,8,["modelValue"])])),_:1}),r(F,{label:"密码",prop:"password"},{default:i((()=>[r(M,{modelValue:C.newUser.password,"onUpdate:modelValue":l[4]||(l[4]=e=>C.newUser.password=e),type:"password",required:""},null,8,["modelValue"])])),_:1}),r(F,{label:"状态"},{default:i((()=>[r(Q,{modelValue:C.newUser.is_active,"onUpdate:modelValue":l[5]||(l[5]=e=>C.newUser.is_active=e)},{default:i((()=>l[23]||(l[23]=[n("活跃")]))),_:1},8,["modelValue"])])),_:1}),r(F,{label:"管理员"},{default:i((()=>[r(Q,{modelValue:C.newUser.is_admin,"onUpdate:modelValue":l[6]||(l[6]=e=>C.newUser.is_admin=e)},{default:i((()=>l[24]||(l[24]=[n("管理员")]))),_:1},8,["modelValue"])])),_:1}),r(F,{label:"角色"},{default:i((()=>[r(L,{modelValue:C.newUser.role_ids,"onUpdate:modelValue":l[7]||(l[7]=e=>C.newUser.role_ids=e)},{default:i((()=>[(t(!0),d(h,null,p(C.roles,(e=>(t(),c(Q,{key:e.id,label:e.id},{default:i((()=>[n(_(e.name),1)])),_:2},1032,["label"])))),128))])),_:1},8,["modelValue"])])),_:1}),r(F,null,{default:i((()=>[r($,{onClick:l[8]||(l[8]=e=>C.showCreateUserModal=!1)},{default:i((()=>l[25]||(l[25]=[n("取消")]))),_:1}),r($,{type:"primary",loading:C.creating,onClick:k.createUser},{default:i((()=>l[26]||(l[26]=[n("创建")]))),_:1},8,["loading","onClick"])])),_:1})])),_:1},8,["onSubmit","model","rules"])])),_:1},8,["modelValue"]),r(j,{modelValue:C.showEditUserModal,"onUpdate:modelValue":l[17]||(l[17]=e=>C.showEditUserModal=e),title:"编辑用户",width:"400px"},{default:i((()=>[r(S,{onSubmit:f(k.updateUser,["prevent"]),model:C.editedUser,rules:C.userRules,ref:"editUserForm","label-width":"80px"},{default:i((()=>[r(F,{label:"用户名",prop:"username"},{default:i((()=>[r(M,{modelValue:C.editedUser.username,"onUpdate:modelValue":l[10]||(l[10]=e=>C.editedUser.username=e),required:"",disabled:""},null,8,["modelValue"])])),_:1}),r(F,{label:"邮箱",prop:"email"},{default:i((()=>[r(M,{modelValue:C.editedUser.email,"onUpdate:modelValue":l[11]||(l[11]=e=>C.editedUser.email=e)},null,8,["modelValue"])])),_:1}),r(F,{label:"密码"},{default:i((()=>[r(M,{modelValue:C.editedUser.password,"onUpdate:modelValue":l[12]||(l[12]=e=>C.editedUser.password=e),type:"password",placeholder:"留空则不修改"},null,8,["modelValue"])])),_:1}),r(F,{label:"状态"},{default:i((()=>[r(Q,{modelValue:C.editedUser.is_active,"onUpdate:modelValue":l[13]||(l[13]=e=>C.editedUser.is_active=e),disabled:C.editedUser.id===C.currentUserId},{default:i((()=>l[27]||(l[27]=[n("活跃")]))),_:1},8,["modelValue","disabled"])])),_:1}),r(F,{label:"管理员"},{default:i((()=>[r(Q,{modelValue:C.editedUser.is_admin,"onUpdate:modelValue":l[14]||(l[14]=e=>C.editedUser.is_admin=e),disabled:C.editedUser.id===C.currentUserId},{default:i((()=>l[28]||(l[28]=[n("管理员")]))),_:1},8,["modelValue","disabled"])])),_:1}),r(F,{label:"角色"},{default:i((()=>[r(L,{modelValue:C.editedUser.role_ids,"onUpdate:modelValue":l[15]||(l[15]=e=>C.editedUser.role_ids=e)},{default:i((()=>[(t(!0),d(h,null,p(C.roles,(e=>(t(),c(Q,{key:e.id,label:e.id},{default:i((()=>[n(_(e.name),1)])),_:2},1032,["label"])))),128))])),_:1},8,["modelValue"])])),_:1}),r(F,null,{default:i((()=>[r($,{onClick:l[16]||(l[16]=e=>C.showEditUserModal=!1)},{default:i((()=>l[29]||(l[29]=[n("取消")]))),_:1}),r($,{type:"primary",loading:C.updating,onClick:k.updateUser},{default:i((()=>l[30]||(l[30]=[n("保存")]))),_:1},8,["loading","onClick"])])),_:1})])),_:1},8,["onSubmit","model","rules"])])),_:1},8,["modelValue"]),r(j,{modelValue:C.showDeleteConfirmModal,"onUpdate:modelValue":l[19]||(l[19]=e=>C.showDeleteConfirmModal=e),title:"确认删除",width:"350px"},{footer:i((()=>[r($,{onClick:l[18]||(l[18]=e=>C.showDeleteConfirmModal=!1)},{default:i((()=>l[33]||(l[33]=[n("取消")]))),_:1}),r($,{type:"danger",loading:C.deleting,onClick:k.deleteUser},{default:i((()=>l[34]||(l[34]=[n("删除")]))),_:1},8,["loading","onClick"])])),default:i((()=>{var e;return[o("div",null,[o("p",null,[l[31]||(l[31]=n("确定要删除用户 ")),o("strong",null,_(null==(e=C.userToDelete)?void 0:e.username),1),l[32]||(l[32]=n(" 吗？此操作不可撤销。"))])])]})),_:1},8,["modelValue"])])}],["__scopeId","data-v-17f82096"]]);export{C as default};
